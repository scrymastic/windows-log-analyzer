title: Potential WinAPI Calls Via CommandLine
id: ba3f5c1b-6272-4119-9dbd-0bc8d21c2702
related:
- id: 03d83090-8cba-44a0-b02f-0b756a050306
  type: derived
status: test
description: Detects the use of WinAPI Functions via the commandline. As seen used
  by threat actors via the tool winapiexec
references:
- https://twitter.com/m417z/status/1566674631788007425
author: Nasreddine Bencherchali (Nextron Systems)
date: 2022/09/06
modified: 2023/01/09
tags:
- attack.execution
- attack.t1106
logsource:
  category: process_creation
  product: windows
detection:
- and:
  - or:
    - CommandLine|contains: AddSecurityPackage
    - CommandLine|contains: AdjustTokenPrivileges
    - CommandLine|contains: Advapi32
    - CommandLine|contains: CloseHandle
    - CommandLine|contains: CreateProcessWithToken
    - CommandLine|contains: CreatePseudoConsole
    - CommandLine|contains: CreateRemoteThread
    - CommandLine|contains: CreateThread
    - CommandLine|contains: CreateUserThread
    - CommandLine|contains: DangerousGetHandle
    - CommandLine|contains: DuplicateTokenEx
    - CommandLine|contains: EnumerateSecurityPackages
    - CommandLine|contains: FreeHGlobal
    - CommandLine|contains: FreeLibrary
    - CommandLine|contains: GetDelegateForFunctionPointer
    - CommandLine|contains: GetLogonSessionData
    - CommandLine|contains: GetModuleHandle
    - CommandLine|contains: GetProcAddress
    - CommandLine|contains: GetProcessHandle
    - CommandLine|contains: GetTokenInformation
    - CommandLine|contains: ImpersonateLoggedOnUser
    - CommandLine|contains: kernel32
    - CommandLine|contains: LoadLibrary
    - CommandLine|contains: memcpy
    - CommandLine|contains: MiniDumpWriteDump
    - CommandLine|contains: ntdll
    - CommandLine|contains: OpenDesktop
    - CommandLine|contains: OpenProcess
    - CommandLine|contains: OpenProcessToken
    - CommandLine|contains: OpenThreadToken
    - CommandLine|contains: OpenWindowStation
    - CommandLine|contains: PtrToString
    - CommandLine|contains: QueueUserApc
    - CommandLine|contains: ReadProcessMemory
    - CommandLine|contains: RevertToSelf
    - CommandLine|contains: RtlCreateUserThread
    - CommandLine|contains: secur32
    - CommandLine|contains: SetThreadToken
    - CommandLine|contains: VirtualAlloc
    - CommandLine|contains: VirtualFree
    - CommandLine|contains: VirtualProtect
    - CommandLine|contains: WaitForSingleObject
    - CommandLine|contains: WriteInt32
    - CommandLine|contains: WriteProcessMemory
    - CommandLine|contains: ZeroFreeGlobalAllocUnicode
falsepositives:
- Unknown
level: high
