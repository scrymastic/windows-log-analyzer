title: PowerShell Base64 Encoded WMI Classes
id: 1816994b-42e1-4fb1-afd2-134d88184f71
related:
- id: 47688f1b-9f51-4656-b013-3cc49a166a36
  type: obsoletes
status: test
description: Detects calls to base64 encoded WMI class such as "Win32_Shadowcopy",
  "Win32_ScheduledJob", etc.
references:
- https://github.com/Neo23x0/Raccine/blob/20a569fa21625086433dcce8bb2765d0ea08dcb6/yara/mal_revil.yar
author: Christian Burkard (Nextron Systems), Nasreddine Bencherchali (Nextron Systems)
date: 2023/01/30
tags:
- attack.execution
- attack.t1059.001
- attack.defense_evasion
- attack.t1027
logsource:
  category: process_creation
  product: windows
detection:
- selection_img:
  - and:
    - or:
      - or:
        - Image|endswith: \powershell.exe
        - Image|endswith: \pwsh.exe
      - or:
        - OriginalFileName|==: PowerShell.EXE
        - OriginalFileName|==: pwsh.dll
- selection_cli_shadowcopy:
  - and:
    - or:
      - CommandLine|contains: VwBpAG4AMwAyAF8AUwBoAGEAZABvAHcAYwBvAHAAeQ
      - CommandLine|contains: cAaQBuADMAMgBfAFMAaABhAGQAbwB3AGMAbwBwAHkA
      - CommandLine|contains: XAGkAbgAzADIAXwBTAGgAYQBkAG8AdwBjAG8AcAB5A
      - CommandLine|contains: V2luMzJfU2hhZG93Y29we
      - CommandLine|contains: dpbjMyX1NoYWRvd2NvcH
      - CommandLine|contains: XaW4zMl9TaGFkb3djb3B5
- selection_cli_scheduledJob:
  - and:
    - or:
      - CommandLine|contains: VwBpAG4AMwAyAF8AUwBjAGgAZQBkAHUAbABlAGQASgBvAGIA
      - CommandLine|contains: cAaQBuADMAMgBfAFMAYwBoAGUAZAB1AGwAZQBkAEoAbwBiA
      - CommandLine|contains: XAGkAbgAzADIAXwBTAGMAaABlAGQAdQBsAGUAZABKAG8AYg
      - CommandLine|contains: V2luMzJfU2NoZWR1bGVkSm9i
      - CommandLine|contains: dpbjMyX1NjaGVkdWxlZEpvY
      - CommandLine|contains: XaW4zMl9TY2hlZHVsZWRKb2
- selection_cli_process:
  - and:
    - or:
      - CommandLine|contains: VwBpAG4AMwAyAF8AUAByAG8AYwBlAHMAcw
      - CommandLine|contains: cAaQBuADMAMgBfAFAAcgBvAGMAZQBzAHMA
      - CommandLine|contains: XAGkAbgAzADIAXwBQAHIAbwBjAGUAcwBzA
      - CommandLine|contains: V2luMzJfUHJvY2Vzc
      - CommandLine|contains: dpbjMyX1Byb2Nlc3
      - CommandLine|contains: XaW4zMl9Qcm9jZXNz
- selection_cli_useraccount:
  - and:
    - or:
      - CommandLine|contains: VwBpAG4AMwAyAF8AVQBzAGUAcgBBAGMAYwBvAHUAbgB0A
      - CommandLine|contains: cAaQBuADMAMgBfAFUAcwBlAHIAQQBjAGMAbwB1AG4AdA
      - CommandLine|contains: XAGkAbgAzADIAXwBVAHMAZQByAEEAYwBjAG8AdQBuAHQA
      - CommandLine|contains: V2luMzJfVXNlckFjY291bn
      - CommandLine|contains: dpbjMyX1VzZXJBY2NvdW50
      - CommandLine|contains: XaW4zMl9Vc2VyQWNjb3Vud
- selection_cli_loggedonuser:
  - and:
    - or:
      - CommandLine|contains: VwBpAG4AMwAyAF8ATABvAGcAZwBlAGQATwBuAFUAcwBlAHIA
      - CommandLine|contains: cAaQBuADMAMgBfAEwAbwBnAGcAZQBkAE8AbgBVAHMAZQByA
      - CommandLine|contains: XAGkAbgAzADIAXwBMAG8AZwBnAGUAZABPAG4AVQBzAGUAcg
      - CommandLine|contains: V2luMzJfTG9nZ2VkT25Vc2Vy
      - CommandLine|contains: dpbjMyX0xvZ2dlZE9uVXNlc
      - CommandLine|contains: XaW4zMl9Mb2dnZWRPblVzZX
- condition: selection_img and 1 of selection_cli_*
falsepositives:
- Unknown
level: high
