title: Potential Data Exfiltration Activity Via CommandLine Tools
id: 7d1aaf3d-4304-425c-b7c3-162055e0b3ab
status: experimental
description: Detects the use of various CLI utilities exfiltrating data via web requests
references:
- https://www.sentinelone.com/blog/living-off-windows-defender-lockbit-ransomware-sideloads-cobalt-strike-through-microsoft-security-tool/
author: Nasreddine Bencherchali (Nextron Systems)
date: 2022/08/02
modified: 2023/07/27
tags:
- attack.execution
- attack.t1059.001
logsource:
  category: process_creation
  product: windows
detection:
- selection_iwr:
  - and:
    - or:
      - Image|endswith: \powershell.exe
      - Image|endswith: \pwsh.exe
      - Image|endswith: \cmd.exe
    - or:
      - CommandLine|contains: Invoke-WebRequest
      - CommandLine|contains: 'iwr '
      - CommandLine|contains: 'wget '
      - CommandLine|contains: 'curl '
    - CommandLine|contains: ' -ur'
    - CommandLine|contains: ' -me'
    - CommandLine|contains: ' -b'
    - CommandLine|contains: ' POST '
- selection_curl:
  - and:
    - Image|endswith: \curl.exe
    - CommandLine|contains: --ur
- selection_curl_data:
  - and:
    - or:
      - CommandLine|contains: ' -d '
      - CommandLine|contains: ' --data '
- selection_wget:
  - and:
    - Image|endswith: \wget.exe
    - or:
      - CommandLine|contains: --post-data
      - CommandLine|contains: --post-file
- payloads:
  - and:
    - or:
      - or:
        - CommandLine|contains: Get-Content
        - CommandLine|contains: GetBytes
        - CommandLine|contains: hostname
        - CommandLine|contains: ifconfig
        - CommandLine|contains: ipconfig
        - CommandLine|contains: net view
        - CommandLine|contains: netstat
        - CommandLine|contains: nltest
        - CommandLine|contains: qprocess
        - CommandLine|contains: sc query
        - CommandLine|contains: systeminfo
        - CommandLine|contains: tasklist
        - CommandLine|contains: ToBase64String
        - CommandLine|contains: whoami
      - and:
        - CommandLine|contains: 'type '
        - CommandLine|contains: ' > '
        - CommandLine|contains: ' C:\'
- condition: (selection_iwr or all of selection_curl* or selection_wget) and payloads
falsepositives:
- Unlikely
level: high
