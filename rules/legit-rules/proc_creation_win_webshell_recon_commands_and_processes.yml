title: Webshell Detection With Command Line Keywords
id: bed2a484-9348-4143-8a8a-b801c979301c
status: test
description: Detects certain command line parameters often used during reconnaissance
  activity via web shells
references:
- https://www.fireeye.com/blog/threat-research/2013/08/breaking-down-the-china-chopper-web-shell-part-ii.html
- https://unit42.paloaltonetworks.com/bumblebee-webshell-xhunt-campaign/
author: Florian Roth (Nextron Systems), Jonhnathan Ribeiro, Anton Kutepov, oscd.community
date: 2017/01/01
modified: 2022/05/13
tags:
- attack.persistence
- attack.t1505.003
- attack.t1018
- attack.t1033
- attack.t1087
logsource:
  category: process_creation
  product: windows
detection:
- selection_webserver_image:
  - and:
    - or:
      - ParentImage|endswith: \w3wp.exe
      - ParentImage|endswith: \php-cgi.exe
      - ParentImage|endswith: \nginx.exe
      - ParentImage|endswith: \httpd.exe
      - ParentImage|endswith: \caddy.exe
      - ParentImage|endswith: \ws_tomcatservice.exe
- selection_webserver_characteristics_tomcat1:
  - and:
    - or:
      - ParentImage|endswith: \java.exe
      - ParentImage|endswith: \javaw.exe
    - or:
      - ParentImage|contains: -tomcat-
      - ParentImage|contains: \tomcat
- selection_webserver_characteristics_tomcat2:
  - and:
    - or:
      - ParentImage|endswith: \java.exe
      - ParentImage|endswith: \javaw.exe
    - or:
      - CommandLine|contains: catalina.jar
      - CommandLine|contains: CATALINA_HOME
- selection_susp_net_utility:
  - and:
    - or:
      - OriginalFileName|==: net.exe
      - OriginalFileName|==: net1.exe
    - or:
      - CommandLine|contains: ' user '
      - CommandLine|contains: ' use '
      - CommandLine|contains: ' group '
- selection_susp_ping_utility:
  - and:
    - OriginalFileName|==: ping.exe
    - CommandLine|contains: ' -n '
- selection_susp_change_dir:
  - and:
    - or:
      - CommandLine|contains: '&cd&echo'
      - CommandLine|contains: 'cd /d '
- selection_susp_wmic_utility:
  - and:
    - OriginalFileName|==: wmic.exe
    - CommandLine|contains: ' /node:'
- selection_susp_misc_discovery_binaries:
  - and:
    - or:
      - or:
        - Image|endswith: \dsquery.exe
        - Image|endswith: \find.exe
        - Image|endswith: \findstr.exe
        - Image|endswith: \ipconfig.exe
        - Image|endswith: \netstat.exe
        - Image|endswith: \nslookup.exe
        - Image|endswith: \pathping.exe
        - Image|endswith: \quser.exe
        - Image|endswith: \schtasks.exe
        - Image|endswith: \systeminfo.exe
        - Image|endswith: \tasklist.exe
        - Image|endswith: \tracert.exe
        - Image|endswith: \ver.exe
        - Image|endswith: \wevtutil.exe
        - Image|endswith: \whoami.exe
      - or:
        - OriginalFileName|==: dsquery.exe
        - OriginalFileName|==: find.exe
        - OriginalFileName|==: findstr.exe
        - OriginalFileName|==: ipconfig.exe
        - OriginalFileName|==: netstat.exe
        - OriginalFileName|==: nslookup.exe
        - OriginalFileName|==: pathping.exe
        - OriginalFileName|==: quser.exe
        - OriginalFileName|==: schtasks.exe
        - OriginalFileName|==: sysinfo.exe
        - OriginalFileName|==: tasklist.exe
        - OriginalFileName|==: tracert.exe
        - OriginalFileName|==: ver.exe
        - OriginalFileName|==: VSSADMIN.EXE
        - OriginalFileName|==: wevtutil.exe
        - OriginalFileName|==: whoami.exe
- selection_susp_misc_discovery_commands:
  - and:
    - or:
      - CommandLine|contains: ' Test-NetConnection '
      - CommandLine|contains: dir \
- condition: 1 of selection_webserver_* and 1 of selection_susp_*
falsepositives:
- Unknown
level: high
