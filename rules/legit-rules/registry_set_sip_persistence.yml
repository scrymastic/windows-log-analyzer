title: Persistence Via New SIP Provider
id: 5a2b21ee-6aaa-4234-ac9d-59a59edf90a1
status: experimental
description: Detects when an attacker register a new SIP provider for persistence
  and defense evasion
references:
- https://persistence-info.github.io/Data/codesigning.html
- https://github.com/gtworek/PSBits/tree/master/SIP
- https://specterops.io/assets/resources/SpecterOps_Subverting_Trust_in_Windows.pdf
author: Nasreddine Bencherchali (Nextron Systems)
date: 2022/07/21
modified: 2023/08/17
tags:
- attack.persistence
- attack.defense_evasion
- attack.t1553.003
logsource:
  category: registry_set
  product: windows
detection:
- and:
  - or:
    - TargetObject|contains: \SOFTWARE\Microsoft\Cryptography\Providers\
    - TargetObject|contains: \SOFTWARE\Microsoft\Cryptography\OID\EncodingType
    - TargetObject|contains: \SOFTWARE\WOW6432Node\Microsoft\Cryptography\Providers\
    - TargetObject|contains: \SOFTWARE\WOW6432Node\Microsoft\Cryptography\OID\EncodingType
  - or:
    - TargetObject|contains: \Dll
    - TargetObject|contains: \$DLL
  - or:
    - Image|!==: C:\Windows\System32\poqexec.exe
    - TargetObject|not contains: \CryptSIPDll
    - Details|!==: C:\Windows\System32\PsfSip.dll
falsepositives:
- Legitimate SIP being registered by the OS or different software.
level: medium
