title: Potentially Suspicious GrantedAccess Flags On LSASS
id: a18dd26b-6450-46de-8c91-9659150cf088
related:
- id: 32d0d3e2-e58d-4d41-926b-18b520b2b32d
  type: similar
status: experimental
description: Detects process access requests to LSASS process with potentially suspicious
  access flags
references:
- https://docs.microsoft.com/en-us/windows/win32/procthread/process-security-and-access-rights
- https://onedrive.live.com/view.aspx?resid=D026B4699190F1E6!2843&ithint=file%2cpptx&app=PowerPoint&authkey=!AMvCRTKB_V1J5ow
- https://web.archive.org/web/20230208123920/https://cyberwardog.blogspot.com/2017/03/chronicles-of-threat-hunter-hunting-for_22.html
- https://www.slideshare.net/heirhabarov/hunting-for-credentials-dumping-in-windows-environment
- http://security-research.dyndns.org/pub/slides/FIRST2017/FIRST-2017_Tom-Ueltschi_Sysmon_FINAL_notes.pdf
author: Florian Roth, Roberto Rodriguez, Dimitrios Slamaris, Mark Russinovich, Thomas
  Patzke, Teymur Kheirkhabarov, Sherif Eldeeb, James Dickenson, Aleksey Potapov, oscd.community
date: 2021/11/22
modified: 2023/11/29
tags:
- attack.credential_access
- attack.t1003.001
- attack.s0002
logsource:
  category: process_access
  product: windows
detection:
- selection_target:
  - and:
    - TargetImage|endswith: \lsass.exe
- selection_access:
  - and:
    - or:
      - or:
        - GrantedAccess|endswith: '30'
        - GrantedAccess|endswith: '50'
        - GrantedAccess|endswith: '70'
        - GrantedAccess|endswith: '90'
        - GrantedAccess|endswith: B0
        - GrantedAccess|endswith: D0
        - GrantedAccess|endswith: F0
        - GrantedAccess|endswith: '18'
        - GrantedAccess|endswith: '38'
        - GrantedAccess|endswith: '58'
        - GrantedAccess|endswith: '78'
        - GrantedAccess|endswith: '98'
        - GrantedAccess|endswith: B8
        - GrantedAccess|endswith: D8
        - GrantedAccess|endswith: F8
        - GrantedAccess|endswith: 1A
        - GrantedAccess|endswith: 3A
        - GrantedAccess|endswith: 5A
        - GrantedAccess|endswith: 7A
        - GrantedAccess|endswith: 9A
        - GrantedAccess|endswith: BA
        - GrantedAccess|endswith: DA
        - GrantedAccess|endswith: FA
        - GrantedAccess|endswith: '0x14C2'
      - or:
        - GrantedAccess|startswith: '0x100000'
        - GrantedAccess|startswith: '0x1418'
        - GrantedAccess|startswith: '0x1438'
        - GrantedAccess|startswith: '0x143a'
        - GrantedAccess|startswith: '0x1f0fff'
        - GrantedAccess|startswith: '0x1f1fff'
        - GrantedAccess|startswith: '0x1f2fff'
        - GrantedAccess|startswith: '0x1f3fff'
        - GrantedAccess|startswith: '0x40'
- filter_main_generic:
  - and:
    - or:
      - SourceImage|contains: :\Program Files (x86)\
      - SourceImage|contains: :\Program Files\
      - SourceImage|contains: :\Windows\System32\
      - SourceImage|contains: :\Windows\SysWOW64\
- filter_optional_malwarebytes:
  - and:
    - SourceImage|endswith: :\ProgramData\MALWAREBYTES\MBAMSERVICE\ctlrupdate\mbupdatr.exe
- filter_optional_vscode:
  - and:
    - SourceImage|endswith: \AppData\Local\Programs\Microsoft VS Code\Code.exe
- filter_main_windefend_1:
  - and:
    - SourceImage|contains: :\ProgramData\Microsoft\Windows Defender\
    - SourceImage|endswith: \MsMpEng.exe
- filter_main_windefend_2:
  - and:
    - CallTrace|contains: '|?:\ProgramData\Microsoft\Windows Defender\Definition Updates\{'
    - CallTrace|contains: '}\mpengine.dll+'
    - GrantedAccess|==: '0x1418'
- filter_main_windefend_3:
  - and:
    - or:
      - CallTrace|contains: '|c:\program files\windows defender\mprtp.dll'
      - CallTrace|contains: '|c:\program files\windows defender\MpClient.dll'
- filter_optional_vmwaretools:
  - and:
    - SourceImage|contains: :\ProgramData\VMware\VMware Tools\
    - SourceImage|endswith: \vmtoolsd.exe
- filter_optional_sysinternals_process_explorer:
  - and:
    - or:
      - SourceImage|endswith: \PROCEXP64.EXE
      - SourceImage|endswith: \PROCEXP.EXE
    - GrantedAccess|==: '0x40'
- filter_optional_mbami:
  - and:
    - SourceImage|endswith: \MBAMInstallerService.exe
    - GrantedAccess|==: '0x40'
- filter_optional_nextron:
  - and:
    - or:
      - SourceImage|endswith: \aurora-agent-64.exe
      - SourceImage|endswith: \aurora-agent.exe
      - SourceImage|endswith: \thor.exe
      - SourceImage|endswith: \thor64.exe
    - GrantedAccess|==: '0x40'
- filter_main_explorer:
  - and:
    - SourceImage|endswith: \explorer.exe
    - GrantedAccess|==: '0x401'
- filter_optional_sysinternals_handle:
  - and:
    - or:
      - SourceImage|endswith: \handle.exe
      - SourceImage|endswith: \handle64.exe
    - GrantedAccess|==: '0x40'
- filter_optional_webex:
  - and:
    - SourceImage|endswith: \AppData\Local\WebEx\WebexHost.exe
    - GrantedAccess|==: '0x401'
- filter_optional_steam_apps:
  - and:
    - SourceImage|contains: \SteamLibrary\steamapps\
- condition: all of selection_* and not 1 of filter_main_* and not 1 of filter_optional_*
falsepositives:
- Legitimate software such as AV and EDR
level: medium
