title: Potential Tampering With RDP Related Registry Keys Via Reg.EXE
id: 0d5675be-bc88-4172-86d3-1e96a4476536
status: test
description: Detects the execution of "reg.exe" for enabling/disabling the RDP service
  on the host by tampering with the 'CurrentControlSet\Control\Terminal Server' values
references:
- https://thedfirreport.com/2022/02/21/qbot-and-zerologon-lead-to-full-domain-compromise/
author: pH-T (Nextron Systems), @Kostastsale, @TheDFIRReport
date: 2022/02/12
modified: 2023/02/05
tags:
- attack.defense_evasion
- attack.lateral_movement
- attack.t1021.001
- attack.t1112
logsource:
  product: windows
  category: process_creation
detection:
- and:
  - or:
    - Image|endswith: \reg.exe
    - OriginalFileName|==: reg.exe
  - CommandLine|contains: ' add '
  - CommandLine|contains: \CurrentControlSet\Control\Terminal Server
  - CommandLine|contains: REG_DWORD
  - CommandLine|contains: ' /f'
  - CommandLine|contains: Licensing Core
  - CommandLine|contains: EnableConcurrentSessions
  - or:
    - CommandLine|contains: WinStations\RDP-Tcp
    - CommandLine|contains: MaxInstanceCount
    - CommandLine|contains: fEnableWinStation
    - CommandLine|contains: TSUserEnabled
    - CommandLine|contains: TSEnabled
    - CommandLine|contains: TSAppCompat
    - CommandLine|contains: IdleWinStationPoolCount
    - CommandLine|contains: TSAdvertise
    - CommandLine|contains: AllowTSConnections
    - CommandLine|contains: fSingleSessionPerUser
    - CommandLine|contains: fDenyTSConnections
falsepositives:
- Unknown
level: high
