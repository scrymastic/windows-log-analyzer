title: Suspicious Persistence Via VMwareToolBoxCmd.EXE VM State Change Script
id: 236d8e89-ed95-4789-a982-36f4643738ba
related:
- id: 7aa4e81a-a65c-4e10-9f81-b200eb229d7d
  type: derived
status: experimental
description: Detects execution of the "VMwareToolBoxCmd.exe" with the "script" and
  "set" flag to setup a specific script that's located in a potentially suspicious
  location to run for a specific VM state
references:
- https://bohops.com/2021/10/08/analyzing-and-detecting-a-vmtools-persistence-technique/
author: Nasreddine Bencherchali (Nextron Systems)
date: 2023/06/14
tags:
- attack.execution
- attack.persistence
- attack.t1059
logsource:
  category: process_creation
  product: windows
detection:
- selection_bin_img:
  - and:
    - or:
      - Image|endswith: \VMwareToolBoxCmd.exe
      - OriginalFileName|==: toolbox-cmd.exe
- selection_bin_cli:
  - and:
    - CommandLine|contains: ' script '
    - CommandLine|contains: ' set '
- selection_susp_paths:
  - and:
    - or:
      - CommandLine|contains: :\PerfLogs\
      - CommandLine|contains: :\Temp\
      - CommandLine|contains: :\Windows\System32\Tasks\
      - CommandLine|contains: :\Windows\Tasks\
      - CommandLine|contains: :\Windows\Temp\
      - CommandLine|contains: \AppData\Local\Temp
- condition: all of selection_*
falsepositives:
- Unknown
level: high
