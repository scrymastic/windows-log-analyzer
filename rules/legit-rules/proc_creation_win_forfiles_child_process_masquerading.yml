title: Forfiles.EXE Child Process Masquerading
id: f53714ec-5077-420e-ad20-907ff9bb2958
status: experimental
description: 'Detects the execution of "forfiles" from a non-default location, in
  order to potentially spawn a custom "cmd.exe" from the current working directory.

  '
references:
- https://www.hexacorn.com/blog/2023/12/31/1-little-known-secret-of-forfiles-exe/
author: Nasreddine Bencherchali (Nextron Systems), Anish Bogati
date: 2024/01/05
tags:
- attack.defense_evasion
- attack.t1036
logsource:
  category: process_creation
  product: windows
detection:
- selection:
  - and:
    - or:
      - ParentCommandLine|endswith: .exe
      - ParentCommandLine|endswith: .exe"
    - Image|endswith: \cmd.exe
    - CommandLine|startswith: /c echo "
- filter_main_parent_not_sys:
  - and:
    - or:
      - ParentImage|contains: :\Windows\System32\
      - ParentImage|contains: :\Windows\SysWOW64\
    - ParentImage|endswith: \forfiles.exe
    - or:
      - Image|contains: :\Windows\System32\
      - Image|contains: :\Windows\SysWOW64\
    - Image|endswith: \cmd.exe
- condition: selection and not 1 of filter_main_*
falsepositives:
- Unknown
level: high
