title: HackTool - Potential Impacket Lateral Movement Activity
id: 10c14723-61c7-4c75-92ca-9af245723ad2
related:
- id: e31f89f7-36fb-4697-8ab6-48823708353b
  type: obsoletes
status: stable
description: Detects wmiexec/dcomexec/atexec/smbexec from Impacket framework
references:
- https://github.com/SecureAuthCorp/impacket/blob/8b1a99f7c715702eafe3f24851817bb64721b156/examples/wmiexec.py
- https://github.com/SecureAuthCorp/impacket/blob/8b1a99f7c715702eafe3f24851817bb64721b156/examples/atexec.py
- https://github.com/SecureAuthCorp/impacket/blob/8b1a99f7c715702eafe3f24851817bb64721b156/examples/smbexec.py
- https://github.com/SecureAuthCorp/impacket/blob/8b1a99f7c715702eafe3f24851817bb64721b156/examples/dcomexec.py
- https://www.elastic.co/guide/en/security/current/suspicious-cmd-execution-via-wmi.html
author: Ecco, oscd.community, Jonhnathan Ribeiro, Tim Rauch
date: 2019/09/03
modified: 2023/02/21
tags:
- attack.execution
- attack.t1047
- attack.lateral_movement
- attack.t1021.003
logsource:
  category: process_creation
  product: windows
detection:
- selection_other:
  - and:
    - or:
      - ParentImage|endswith: \wmiprvse.exe
      - ParentImage|endswith: \mmc.exe
      - ParentImage|endswith: \explorer.exe
      - ParentImage|endswith: \services.exe
    - CommandLine|contains: cmd.exe
    - CommandLine|contains: /Q
    - CommandLine|contains: /c
    - CommandLine|contains: \\\\127.0.0.1\\
    - CommandLine|contains: '&1'
- selection_atexec:
  - and:
    - or:
      - ParentCommandLine|contains: svchost.exe -k netsvcs
      - ParentCommandLine|contains: taskeng.exe
    - CommandLine|contains: cmd.exe
    - CommandLine|contains: /C
    - CommandLine|contains: Windows\Temp\
    - CommandLine|contains: '&1'
- condition: 1 of selection_*
fields:
- CommandLine
- ParentCommandLine
falsepositives:
- Unknown
level: high
