title: Potentially Suspicious PowerShell Child Processes
id: e4b6d2a7-d8a4-4f19-acbd-943c16d90647
status: test
description: Detects potentially suspicious child processes spawned by PowerShell
references:
- https://twitter.com/ankit_anubhav/status/1518835408502620162
author: Florian Roth (Nextron Systems), Tim Shelton
date: 2022/04/26
modified: 2023/05/30
tags:
- attack.execution
- attack.t1059.001
logsource:
  category: process_creation
  product: windows
detection:
- selection:
  - and:
    - or:
      - ParentImage|endswith: \powershell_ise.exe
      - ParentImage|endswith: \powershell.exe
      - ParentImage|endswith: \pwsh.exe
    - or:
      - Image|endswith: \bash.exe
      - Image|endswith: \bitsadmin.exe
      - Image|endswith: \certutil.exe
      - Image|endswith: \cscript.exe
      - Image|endswith: \forfiles.exe
      - Image|endswith: \hh.exe
      - Image|endswith: \mshta.exe
      - Image|endswith: \regsvr32.exe
      - Image|endswith: \rundll32.exe
      - Image|endswith: \schtasks.exe
      - Image|endswith: \scrcons.exe
      - Image|endswith: \scriptrunner.exe
      - Image|endswith: \sh.exe
      - Image|endswith: \wmic.exe
      - Image|endswith: \wscript.exe
- filter_optional_amazon:
  - and:
    - ParentCommandLine|contains: \Program Files\Amazon\WorkspacesConfig\Scripts\
    - CommandLine|contains: \Program Files\Amazon\WorkspacesConfig\Scripts\
- condition: selection and not 1 of filter_optional_*
falsepositives:
- Some false positive is to be expected from PowerShell scripts that might make use
  of additional binaries such as "mshta", "bitsadmin", etc. Apply additional filters
  for those scripts when needed.
level: high
