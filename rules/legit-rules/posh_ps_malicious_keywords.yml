title: Malicious PowerShell Keywords
id: f62176f3-8128-4faa-bf6c-83261322e5eb
status: test
description: Detects keywords from well-known PowerShell exploitation frameworks
references:
- https://adsecurity.org/?p=2921
author: Sean Metcalf (source), Florian Roth (Nextron Systems)
date: 2017/03/05
modified: 2023/06/20
tags:
- attack.execution
- attack.t1059.001
logsource:
  product: windows
  category: ps_script
  definition: 'Requirements: Script Block Logging must be enabled'
detection:
- and:
  - or:
    - ScriptBlockText|contains: AdjustTokenPrivileges
    - ScriptBlockText|contains: IMAGE_NT_OPTIONAL_HDR64_MAGIC
    - ScriptBlockText|contains: Metasploit
    - ScriptBlockText|contains: Microsoft.Win32.UnsafeNativeMethods
    - ScriptBlockText|contains: Mimikatz
    - ScriptBlockText|contains: MiniDumpWriteDump
    - ScriptBlockText|contains: PAGE_EXECUTE_READ
    - ScriptBlockText|contains: ReadProcessMemory.Invoke
    - ScriptBlockText|contains: SE_PRIVILEGE_ENABLED
    - ScriptBlockText|contains: SECURITY_DELEGATION
    - ScriptBlockText|contains: TOKEN_ADJUST_PRIVILEGES
    - ScriptBlockText|contains: TOKEN_ALL_ACCESS
    - ScriptBlockText|contains: TOKEN_ASSIGN_PRIMARY
    - ScriptBlockText|contains: TOKEN_DUPLICATE
    - ScriptBlockText|contains: TOKEN_ELEVATION
    - ScriptBlockText|contains: TOKEN_IMPERSONATE
    - ScriptBlockText|contains: TOKEN_INFORMATION_CLASS
    - ScriptBlockText|contains: TOKEN_PRIVILEGES
    - ScriptBlockText|contains: TOKEN_QUERY
falsepositives:
- Depending on the scripts, this rule might require some initial tuning to fit the
  environment
level: medium
