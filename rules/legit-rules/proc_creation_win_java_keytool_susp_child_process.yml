title: Suspicious Shells Spawn by Java Utility Keytool
id: 90fb5e62-ca1f-4e22-b42e-cc521874c938
status: test
description: Detects suspicious shell spawn from Java utility keytool process (e.g.
  adselfservice plus exploitation)
references:
- https://redcanary.com/blog/intelligence-insights-december-2021
- https://www.synacktiv.com/en/publications/how-to-exploit-cve-2021-40539-on-manageengine-adselfservice-plus.html
author: Andreas Hunkeler (@Karneades)
date: 2021/12/22
modified: 2023/01/21
tags:
- attack.initial_access
- attack.persistence
- attack.privilege_escalation
logsource:
  category: process_creation
  product: windows
detection:
- and:
  - ParentImage|endswith: \keytool.exe
  - or:
    - Image|endswith: \cmd.exe
    - Image|endswith: \sh.exe
    - Image|endswith: \bash.exe
    - Image|endswith: \powershell.exe
    - Image|endswith: \pwsh.exe
    - Image|endswith: \schtasks.exe
    - Image|endswith: \certutil.exe
    - Image|endswith: \whoami.exe
    - Image|endswith: \bitsadmin.exe
    - Image|endswith: \wscript.exe
    - Image|endswith: \cscript.exe
    - Image|endswith: \scrcons.exe
    - Image|endswith: \regsvr32.exe
    - Image|endswith: \hh.exe
    - Image|endswith: \wmic.exe
    - Image|endswith: \mshta.exe
    - Image|endswith: \rundll32.exe
    - Image|endswith: \forfiles.exe
    - Image|endswith: \scriptrunner.exe
    - Image|endswith: \mftrace.exe
    - Image|endswith: \AppVLP.exe
    - Image|endswith: \systeminfo.exe
    - Image|endswith: \reg.exe
    - Image|endswith: \query.exe
falsepositives:
- Unknown
level: high
