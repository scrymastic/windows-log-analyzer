title: Weak Encryption Enabled and Kerberoast
id: f6de9536-0441-4b3f-a646-f4e00f300ffd
status: test
description: Detects scenario where weak encryption is enabled for a user profile
  which could be used for hash/password cracking.
references:
- https://adsecurity.org/?p=2053
- https://blog.harmj0y.net/redteaming/another-word-on-delegation/
author: '@neu5ron'
date: 2017/07/30
modified: 2021/11/27
tags:
- attack.defense_evasion
- attack.t1562.001
logsource:
  product: windows
  service: security
  definition: 'Requirements: Audit Policy : Account Management > Audit User Account
    Management, Group Policy : Computer Configuration\Windows Settings\Security Settings\Advanced
    Audit Policy Configuration\Audit Policies\Account Management\Audit User Account
    Management'
detection:
- selection:
  - and:
    - EventID|==: 4738
- olduac_des:
  - and:
    - or:
      - OldUacValue|endswith: 8???
      - OldUacValue|endswith: 9???
      - OldUacValue|endswith: A???
      - OldUacValue|endswith: B???
      - OldUacValue|endswith: C???
      - OldUacValue|endswith: D???
      - OldUacValue|endswith: E???
      - OldUacValue|endswith: F???
- newuac_des:
  - and:
    - or:
      - NewUacValue|endswith: 8???
      - NewUacValue|endswith: 9???
      - NewUacValue|endswith: A???
      - NewUacValue|endswith: B???
      - NewUacValue|endswith: C???
      - NewUacValue|endswith: D???
      - NewUacValue|endswith: E???
      - NewUacValue|endswith: F???
- olduac_preauth:
  - and:
    - or:
      - OldUacValue|endswith: 1????
      - OldUacValue|endswith: 3????
      - OldUacValue|endswith: 5????
      - OldUacValue|endswith: 7????
      - OldUacValue|endswith: 9????
      - OldUacValue|endswith: B????
      - OldUacValue|endswith: D????
      - OldUacValue|endswith: F????
- newuac_preauth:
  - and:
    - or:
      - NewUacValue|endswith: 1????
      - NewUacValue|endswith: 3????
      - NewUacValue|endswith: 5????
      - NewUacValue|endswith: 7????
      - NewUacValue|endswith: 9????
      - NewUacValue|endswith: B????
      - NewUacValue|endswith: D????
      - NewUacValue|endswith: F????
- olduac_encrypted:
  - and:
    - or:
      - OldUacValue|endswith: 8??
      - OldUacValue|endswith: 9??
      - OldUacValue|endswith: A??
      - OldUacValue|endswith: B??
      - OldUacValue|endswith: C??
      - OldUacValue|endswith: D??
      - OldUacValue|endswith: E??
      - OldUacValue|endswith: F??
- newuac_encrypted:
  - and:
    - or:
      - NewUacValue|endswith: 8??
      - NewUacValue|endswith: 9??
      - NewUacValue|endswith: A??
      - NewUacValue|endswith: B??
      - NewUacValue|endswith: C??
      - NewUacValue|endswith: D??
      - NewUacValue|endswith: E??
      - NewUacValue|endswith: F??
- condition: selection and ((newuac_des and not olduac_des) or (newuac_preauth and
    not olduac_preauth) or (newuac_encrypted and not olduac_encrypted))
falsepositives:
- Unknown
level: high
