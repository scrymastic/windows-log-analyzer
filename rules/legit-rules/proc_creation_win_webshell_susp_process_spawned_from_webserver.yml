title: Suspicious Process By Web Server Process
id: 8202070f-edeb-4d31-a010-a26c72ac5600
status: test
description: 'Detects potentially suspicious processes being spawned by a web server
  process which could be the result of a successfully placed web shell or exploitation

  '
references:
- https://media.defense.gov/2020/Jun/09/2002313081/-1/-1/0/CSI-DETECT-AND-PREVENT-WEB-SHELL-MALWARE-20200422.PDF
author: Thomas Patzke, Florian Roth (Nextron Systems), Zach Stanford @svch0st, Tim
  Shelton, Nasreddine Bencherchali (Nextron Systems)
date: 2019/01/16
modified: 2023/11/11
tags:
- attack.persistence
- attack.t1505.003
- attack.t1190
logsource:
  category: process_creation
  product: windows
detection:
- selection_webserver_image:
  - and:
    - or:
      - ParentImage|endswith: \caddy.exe
      - ParentImage|endswith: \httpd.exe
      - ParentImage|endswith: \nginx.exe
      - ParentImage|endswith: \php-cgi.exe
      - ParentImage|endswith: \php.exe
      - ParentImage|endswith: \tomcat.exe
      - ParentImage|endswith: \UMWorkerProcess.exe
      - ParentImage|endswith: \w3wp.exe
      - ParentImage|endswith: \ws_TomcatService.exe
- selection_webserver_characteristics_tomcat1:
  - and:
    - or:
      - ParentImage|endswith: \java.exe
      - ParentImage|endswith: \javaw.exe
    - or:
      - ParentImage|contains: -tomcat-
      - ParentImage|contains: \tomcat
- selection_webserver_characteristics_tomcat2:
  - and:
    - or:
      - ParentImage|endswith: \java.exe
      - ParentImage|endswith: \javaw.exe
    - or:
      - ParentCommandLine|contains: CATALINA_HOME
      - ParentCommandLine|contains: catalina.home
      - ParentCommandLine|contains: catalina.jar
- selection_anomaly_children:
  - and:
    - or:
      - Image|endswith: \arp.exe
      - Image|endswith: \at.exe
      - Image|endswith: \bash.exe
      - Image|endswith: \bitsadmin.exe
      - Image|endswith: \certutil.exe
      - Image|endswith: \cmd.exe
      - Image|endswith: \cscript.exe
      - Image|endswith: \dsget.exe
      - Image|endswith: \hostname.exe
      - Image|endswith: \nbtstat.exe
      - Image|endswith: \net.exe
      - Image|endswith: \net1.exe
      - Image|endswith: \netdom.exe
      - Image|endswith: \netsh.exe
      - Image|endswith: \nltest.exe
      - Image|endswith: \ntdutil.exe
      - Image|endswith: \powershell_ise.exe
      - Image|endswith: \powershell.exe
      - Image|endswith: \pwsh.exe
      - Image|endswith: \qprocess.exe
      - Image|endswith: \query.exe
      - Image|endswith: \qwinsta.exe
      - Image|endswith: \reg.exe
      - Image|endswith: \rundll32.exe
      - Image|endswith: \sc.exe
      - Image|endswith: \sh.exe
      - Image|endswith: \wmic.exe
      - Image|endswith: \wscript.exe
      - Image|endswith: \wusa.exe
- filter_main_fp_1:
  - and:
    - ParentImage|endswith: \java.exe
    - CommandLine|endswith: Windows\system32\cmd.exe /c C:\ManageEngine\ADManager
        "Plus\ES\bin\elasticsearch.bat -Enode.name=RMP-NODE1 -pelasticsearch-pid.txt
- filter_main_fp_2:
  - and:
    - ParentImage|endswith: \java.exe
    - CommandLine|contains: sc query
    - CommandLine|contains: ADManager Plus
- condition: 1 of selection_webserver_* and selection_anomaly_children and not 1 of
    filter_main_*
falsepositives:
- Particular web applications may spawn a shell process legitimately
level: high
