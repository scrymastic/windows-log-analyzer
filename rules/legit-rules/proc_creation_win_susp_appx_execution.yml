title: Potentially Suspicious Windows App Activity
id: f91ed517-a6ba-471d-9910-b3b4a398c0f3
status: experimental
description: Detects potentially suspicious child process of applications launched
  from inside the WindowsApps directory. This could be a sign of a rogue ".appx" package
  installation/execution
references:
- https://news.sophos.com/en-us/2021/11/11/bazarloader-call-me-back-attack-abuses-windows-10-apps-mechanism/
- https://www.sentinelone.com/labs/inside-malicious-windows-apps-for-malware-deployment/
author: Nasreddine Bencherchali (Nextron Systems)
date: 2023/01/12
modified: 2023/08/31
tags:
- attack.defense_evasion
logsource:
  product: windows
  category: process_creation
detection:
- selection_parent:
  - and:
    - ParentImage|contains: C:\Program Files\WindowsApps\
- selection_susp_img:
  - and:
    - or:
      - Image|endswith: \cmd.exe
      - Image|endswith: \cscript.exe
      - Image|endswith: \mshta.exe
      - Image|endswith: \powershell.exe
      - Image|endswith: \pwsh.exe
      - Image|endswith: \regsvr32.exe
      - Image|endswith: \rundll32.exe
      - Image|endswith: \wscript.exe
- selection_susp_cli:
  - and:
    - or:
      - CommandLine|contains: cmd /c
      - CommandLine|contains: Invoke-
      - CommandLine|contains: Base64
- filter_optional_terminal:
  - and:
    - ParentImage|contains: :\Program Files\WindowsApps\Microsoft.WindowsTerminal
    - ParentImage|endswith: \WindowsTerminal.exe
    - or:
      - Image|endswith: \powershell.exe
      - Image|endswith: \cmd.exe
      - Image|endswith: \pwsh.exe
- condition: selection_parent and 1 of selection_susp_* and not 1 of filter_optional_*
falsepositives:
- Legitimate packages that make use of external binaries such as Windows Terminal
level: medium
