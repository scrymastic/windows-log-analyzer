title: Potential Persistence Via COM Search Order Hijacking
id: a0ff33d8-79e4-4cef-b4f3-9dc4133ccd12
status: experimental
description: Detects potential COM object hijacking leveraging the COM Search Order
references:
- https://www.cyberbit.com/blog/endpoint-security/com-hijacking-windows-overlooked-security-vulnerability/
author: "Maxime Thiebaut (@0xThiebaut), oscd.community, C\xE9dric Hien"
date: 2020/04/14
modified: 2023/09/28
tags:
- attack.persistence
- attack.t1546.015
logsource:
  category: registry_set
  product: windows
detection:
- and:
  - TargetObject|contains: \CLSID\
  - TargetObject|endswith: \InprocServer32\(Default)
  - Details|not contains: '%%systemroot%%\system32\'
  - Details|not contains: '%%systemroot%%\SysWow64\'
  - Details|not contains: \AppData\Local\Microsoft\OneDrive\
  - Details|not contains: \FileCoAuthLib64.dll
  - Details|not contains: \FileSyncShell64.dll
  - Details|not contains: \FileSyncApi64.dll
  - or:
    - Image|not endswith: :\WINDOWS\system32\SecurityHealthService.exe
  - or:
    - Details|not contains: \AppData\Local\Microsoft\TeamsMeetingAddin\
    - Details|not contains: \Microsoft.Teams.AddinLoader.dll
  - or:
    - Details|not contains: \AppData\Roaming\Dropbox\
    - Details|not contains: \DropboxExt64.*.dll
  - or:
    - Details|not endswith: TmopIEPlg.dll
  - Image|not endswith: :\WINDOWS\system32\wuauclt.exe
  - Image|not endswith: :\WINDOWS\system32\svchost.exe
  - Image|not contains: :\ProgramData\Microsoft\Windows Defender\Platform\
  - Image|not contains: :\Program Files\Windows Defender\
  - or:
    - Details|not contains: \FileRepository\nvmdi.inf
  - or:
    - Image|not endswith: \MicrosoftEdgeUpdateComRegisterShell64.exe
  - or:
    - Image|not endswith: :\WINDOWS\SYSTEM32\dxdiag.exe
  - Details|not endswith: :\Windows\pyshellext.amd64.dll
  - Details|not endswith: :\Windows\pyshellext.dll
  - Details|not endswith: :\Windows\system32\dnssdX.dll
  - Details|not endswith: :\Windows\SysWOW64\dnssdX.dll
  - or:
    - Details|not endswith: :\Windows\system32\spool\drivers\x64\3\PrintConfig.dll
  - Details|not contains: :\Program Files\
  - Details|not contains: :\Program Files (x86)\
  - or:
    - Details|not contains: :\ProgramData\Microsoft\
  - or:
    - Details|not contains: :\WINDOWS\system32\GamingServicesProxy.dll
  - or:
    - Image|not endswith: :\Windows\System32\poqexec.exe
    - Details|not contains: :\Windows\System32\Autopilot.dll
  - or:
    - Image|not endswith: :\Windows\system32\SecurityHealthService.exe
    - Details|not contains: :\Windows\System32\SecurityHealth
  - Image|not endswith: :\Windows\System32\poqexec.exe
  - Image|not endswith: :\Windows\System32\regsvr32.exe
falsepositives:
- Some installed utilities (i.e. OneDrive) may serve new COM objects at user-level
level: medium
