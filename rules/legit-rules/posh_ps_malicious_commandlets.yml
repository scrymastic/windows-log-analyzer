title: Malicious PowerShell Commandlets - ScriptBlock
id: 89819aa4-bbd6-46bc-88ec-c7f7fe30efa6
related:
- id: 7d0d0329-0ef1-4e84-a9f5-49500f9d7c6c
  type: similar
- id: 02030f2f-6199-49ec-b258-ea71b07e03dc
  type: similar
- id: 6d3f1399-a81c-4409-aff3-1ecfe9330baf
  type: obsoletes
- id: 83083ac6-1816-4e76-97d7-59af9a9ae46e
  type: obsoletes
status: test
description: Detects Commandlet names from well-known PowerShell exploitation frameworks
references:
- https://adsecurity.org/?p=2921
- https://github.com/S3cur3Th1sSh1t/PowerSharpPack/tree/master/PowerSharpBinaries
- https://github.com/BC-SECURITY/Invoke-ZeroLogon/blob/111d17c7fec486d9bb23387e2e828b09a26075e4/Invoke-ZeroLogon.ps1
- https://github.com/xorrior/RandomPS-Scripts/blob/848c919bfce4e2d67b626cbcf4404341cfe3d3b6/Get-DXWebcamVideo.ps1
- https://github.com/rvrsh3ll/Misc-Powershell-Scripts/blob/6f23bb41f9675d7e2d32bacccff75e931ae00554/OfficeMemScraper.ps1
- https://github.com/dafthack/DomainPasswordSpray/blob/b13d64a5834694aa73fd2aea9911a83027c465a7/DomainPasswordSpray.ps1
- https://unit42.paloaltonetworks.com/threat-assessment-black-basta-ransomware/
- https://research.nccgroup.com/2022/06/06/shining-the-light-on-black-basta/
- https://github.com/calebstewart/CVE-2021-1675
- https://github.com/BloodHoundAD/BloodHound/blob/0927441f67161cc6dc08a53c63ceb8e333f55874/Collectors/AzureHound.ps1
- https://bloodhound.readthedocs.io/en/latest/data-collection/azurehound.html
- https://github.com/HarmJ0y/DAMP
- https://github.com/samratashok/nishang
- https://github.com/DarkCoderSc/PowerRunAsSystem/
- https://github.com/besimorhino/powercat
- https://github.com/Kevin-Robertson/Powermad
- https://github.com/adrecon/ADRecon
- https://github.com/adrecon/AzureADRecon
author: Sean Metcalf, Florian Roth, Bartlomiej Czyz @bczyz1, oscd.community, Nasreddine
  Bencherchali, Tim Shelton, Mustafa Kaan Demir, Georg Lauenstein, Max Altgelt, Tobias
  Michalski, Austin Songer
date: 2017/03/05
modified: 2024/01/25
tags:
- attack.execution
- attack.discovery
- attack.t1482
- attack.t1087
- attack.t1087.001
- attack.t1087.002
- attack.t1069.001
- attack.t1069.002
- attack.t1069
- attack.t1059.001
logsource:
  product: windows
  category: ps_script
  definition: 'Requirements: Script Block Logging must be enabled'
detection:
- selection:
  - and:
    - or:
      - ScriptBlockText|contains: Add-Exfiltration
      - ScriptBlockText|contains: Add-Persistence
      - ScriptBlockText|contains: Add-RegBackdoor
      - ScriptBlockText|contains: Add-RemoteRegBackdoor
      - ScriptBlockText|contains: Add-ScrnSaveBackdoor
      - ScriptBlockText|contains: ConvertTo-Rc4ByteStream
      - ScriptBlockText|contains: Decrypt-Hash
      - ScriptBlockText|contains: Disable-ADIDNSNode
      - ScriptBlockText|contains: Do-Exfiltration
      - ScriptBlockText|contains: Enable-ADIDNSNode
      - ScriptBlockText|contains: Enabled-DuplicateToken
      - ScriptBlockText|contains: Exploit-Jboss
      - ScriptBlockText|contains: Export-ADRCSV
      - ScriptBlockText|contains: Export-ADRExcel
      - ScriptBlockText|contains: Export-ADRHTML
      - ScriptBlockText|contains: Export-ADRJSON
      - ScriptBlockText|contains: Export-ADRXML
      - ScriptBlockText|contains: Find-Fruit
      - ScriptBlockText|contains: Find-GPOLocation
      - ScriptBlockText|contains: Find-TrustedDocuments
      - ScriptBlockText|contains: Get-ADIDNSNodeAttribute
      - ScriptBlockText|contains: Get-ADIDNSNodeOwner
      - ScriptBlockText|contains: Get-ADIDNSNodeTombstoned
      - ScriptBlockText|contains: Get-ADIDNSPermission
      - ScriptBlockText|contains: Get-ADIDNSZone
      - ScriptBlockText|contains: Get-ChromeDump
      - ScriptBlockText|contains: Get-ClipboardContents
      - ScriptBlockText|contains: Get-FoxDump
      - ScriptBlockText|contains: Get-GPPPassword
      - ScriptBlockText|contains: Get-IndexedItem
      - ScriptBlockText|contains: Get-KerberosAESKey
      - ScriptBlockText|contains: Get-Keystrokes
      - ScriptBlockText|contains: Get-LSASecret
      - ScriptBlockText|contains: Get-PassHashes
      - ScriptBlockText|contains: Get-RegAlwaysInstallElevated
      - ScriptBlockText|contains: Get-RegAutoLogon
      - ScriptBlockText|contains: Get-RemoteBootKey
      - ScriptBlockText|contains: Get-RemoteCachedCredential
      - ScriptBlockText|contains: Get-RemoteLocalAccountHash
      - ScriptBlockText|contains: Get-RemoteLSAKey
      - ScriptBlockText|contains: Get-RemoteMachineAccountHash
      - ScriptBlockText|contains: Get-RemoteNLKMKey
      - ScriptBlockText|contains: Get-RickAstley
      - ScriptBlockText|contains: Get-SecurityPackages
      - ScriptBlockText|contains: Get-ServiceFilePermission
      - ScriptBlockText|contains: Get-ServicePermission
      - ScriptBlockText|contains: Get-ServiceUnquoted
      - ScriptBlockText|contains: Get-SiteListPassword
      - ScriptBlockText|contains: Get-System
      - ScriptBlockText|contains: Get-TimedScreenshot
      - ScriptBlockText|contains: Get-UnattendedInstallFile
      - ScriptBlockText|contains: Get-Unconstrained
      - ScriptBlockText|contains: Get-USBKeystrokes
      - ScriptBlockText|contains: Get-VaultCredential
      - ScriptBlockText|contains: Get-VulnAutoRun
      - ScriptBlockText|contains: Get-VulnSchTask
      - ScriptBlockText|contains: Grant-ADIDNSPermission
      - ScriptBlockText|contains: Gupt-Backdoor
      - ScriptBlockText|contains: Invoke-ACLScanner
      - ScriptBlockText|contains: Invoke-ADRecon
      - ScriptBlockText|contains: Invoke-ADSBackdoor
      - ScriptBlockText|contains: Invoke-AgentSmith
      - ScriptBlockText|contains: Invoke-AllChecks
      - ScriptBlockText|contains: Invoke-ARPScan
      - ScriptBlockText|contains: Invoke-AzureHound
      - ScriptBlockText|contains: Invoke-BackdoorLNK
      - ScriptBlockText|contains: Invoke-BadPotato
      - ScriptBlockText|contains: Invoke-BetterSafetyKatz
      - ScriptBlockText|contains: Invoke-BypassUAC
      - ScriptBlockText|contains: Invoke-Carbuncle
      - ScriptBlockText|contains: Invoke-Certify
      - ScriptBlockText|contains: Invoke-ConPtyShell
      - ScriptBlockText|contains: Invoke-CredentialInjection
      - ScriptBlockText|contains: Invoke-DAFT
      - ScriptBlockText|contains: Invoke-DCSync
      - ScriptBlockText|contains: Invoke-DinvokeKatz
      - ScriptBlockText|contains: Invoke-DllInjection
      - ScriptBlockText|contains: Invoke-DNSUpdate
      - ScriptBlockText|contains: Invoke-DomainPasswordSpray
      - ScriptBlockText|contains: Invoke-DowngradeAccount
      - ScriptBlockText|contains: Invoke-EgressCheck
      - ScriptBlockText|contains: Invoke-Eyewitness
      - ScriptBlockText|contains: Invoke-FakeLogonScreen
      - ScriptBlockText|contains: Invoke-Farmer
      - ScriptBlockText|contains: Invoke-Get-RBCD-Threaded
      - ScriptBlockText|contains: Invoke-Gopher
      - ScriptBlockText|contains: Invoke-Grouper
      - ScriptBlockText|contains: Invoke-HandleKatz
      - ScriptBlockText|contains: Invoke-ImpersonatedProcess
      - ScriptBlockText|contains: Invoke-ImpersonateSystem
      - ScriptBlockText|contains: Invoke-InteractiveSystemPowerShell
      - ScriptBlockText|contains: Invoke-Internalmonologue
      - ScriptBlockText|contains: Invoke-Inveigh
      - ScriptBlockText|contains: Invoke-InveighRelay
      - ScriptBlockText|contains: Invoke-KrbRelay
      - ScriptBlockText|contains: Invoke-LdapSignCheck
      - ScriptBlockText|contains: Invoke-Lockless
      - ScriptBlockText|contains: Invoke-MalSCCM
      - ScriptBlockText|contains: Invoke-Mimikatz
      - ScriptBlockText|contains: Invoke-Mimikittenz
      - ScriptBlockText|contains: Invoke-MITM6
      - ScriptBlockText|contains: Invoke-NanoDump
      - ScriptBlockText|contains: Invoke-NetRipper
      - ScriptBlockText|contains: Invoke-Nightmare
      - ScriptBlockText|contains: Invoke-NinjaCopy
      - ScriptBlockText|contains: Invoke-OfficeScrape
      - ScriptBlockText|contains: Invoke-OxidResolver
      - ScriptBlockText|contains: Invoke-P0wnedshell
      - ScriptBlockText|contains: Invoke-Paranoia
      - ScriptBlockText|contains: Invoke-PortScan
      - ScriptBlockText|contains: Invoke-PoshRatHttp
      - ScriptBlockText|contains: Invoke-PostExfil
      - ScriptBlockText|contains: Invoke-PowerDump
      - ScriptBlockText|contains: Invoke-PowerShellTCP
      - ScriptBlockText|contains: Invoke-PowerShellWMI
      - ScriptBlockText|contains: Invoke-PPLDump
      - ScriptBlockText|contains: Invoke-PsExec
      - ScriptBlockText|contains: Invoke-PSInject
      - ScriptBlockText|contains: Invoke-PsUaCme
      - ScriptBlockText|contains: Invoke-ReflectivePEInjection
      - ScriptBlockText|contains: Invoke-ReverseDNSLookup
      - ScriptBlockText|contains: Invoke-Rubeus
      - ScriptBlockText|contains: Invoke-RunAs
      - ScriptBlockText|contains: Invoke-SafetyKatz
      - ScriptBlockText|contains: Invoke-SauronEye
      - ScriptBlockText|contains: Invoke-SCShell
      - ScriptBlockText|contains: Invoke-Seatbelt
      - ScriptBlockText|contains: Invoke-ServiceAbuse
      - ScriptBlockText|contains: Invoke-ShadowSpray
      - ScriptBlockText|contains: Invoke-Sharp
      - ScriptBlockText|contains: Invoke-Shellcode
      - ScriptBlockText|contains: Invoke-SMBScanner
      - ScriptBlockText|contains: Invoke-Snaffler
      - ScriptBlockText|contains: Invoke-Spoolsample
      - ScriptBlockText|contains: Invoke-SpraySinglePassword
      - ScriptBlockText|contains: Invoke-SSHCommand
      - ScriptBlockText|contains: Invoke-StandIn
      - ScriptBlockText|contains: Invoke-StickyNotesExtract
      - ScriptBlockText|contains: Invoke-SystemCommand
      - ScriptBlockText|contains: Invoke-Tasksbackdoor
      - ScriptBlockText|contains: Invoke-Tater
      - ScriptBlockText|contains: Invoke-Thunderfox
      - ScriptBlockText|contains: Invoke-ThunderStruck
      - ScriptBlockText|contains: Invoke-TokenManipulation
      - ScriptBlockText|contains: Invoke-Tokenvator
      - ScriptBlockText|contains: Invoke-TotalExec
      - ScriptBlockText|contains: Invoke-UrbanBishop
      - ScriptBlockText|contains: Invoke-UserHunter
      - ScriptBlockText|contains: Invoke-VoiceTroll
      - ScriptBlockText|contains: Invoke-Whisker
      - ScriptBlockText|contains: Invoke-WinEnum
      - ScriptBlockText|contains: Invoke-winPEAS
      - ScriptBlockText|contains: Invoke-WireTap
      - ScriptBlockText|contains: Invoke-WmiCommand
      - ScriptBlockText|contains: Invoke-WMIExec
      - ScriptBlockText|contains: Invoke-WScriptBypassUAC
      - ScriptBlockText|contains: Invoke-Zerologon
      - ScriptBlockText|contains: MailRaider
      - ScriptBlockText|contains: New-ADIDNSNode
      - ScriptBlockText|contains: New-HoneyHash
      - ScriptBlockText|contains: New-InMemoryModule
      - ScriptBlockText|contains: New-SOASerialNumberArray
      - ScriptBlockText|contains: Out-Minidump
      - ScriptBlockText|contains: PowerBreach
      - ScriptBlockText|contains: 'powercat '
      - ScriptBlockText|contains: PowerUp
      - ScriptBlockText|contains: PowerView
      - ScriptBlockText|contains: Remove-ADIDNSNode
      - ScriptBlockText|contains: Remove-Update
      - ScriptBlockText|contains: Rename-ADIDNSNode
      - ScriptBlockText|contains: Revoke-ADIDNSPermission
      - ScriptBlockText|contains: Set-ADIDNSNode
      - ScriptBlockText|contains: Show-TargetScreen
      - ScriptBlockText|contains: Start-CaptureServer
      - ScriptBlockText|contains: Start-Dnscat2
      - ScriptBlockText|contains: Start-WebcamRecorder
      - ScriptBlockText|contains: VolumeShadowCopyTools
- filter_optional_amazon_ec2:
  - and:
    - or:
      - ScriptBlockText|contains: Get-SystemDriveInfo
      - ScriptBlockText|contains: C:\ProgramData\Amazon\EC2-Windows\Launch\Module\
- condition: selection and not 1 of filter_optional_*
falsepositives:
- Unknown
level: high
