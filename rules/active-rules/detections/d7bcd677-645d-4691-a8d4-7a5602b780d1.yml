detection:
- selection_img:
  - and:
    - or:
      - or:
        - Image|endswith: \powershell.exe
        - Image|endswith: \pwsh.exe
      - or:
        - OriginalFileName|==: PowerShell.EXE
        - OriginalFileName|==: pwsh.dll
- selection_re:
  - and:
    - or:
      - CommandLine|matches: .*\+.*\+.*\+.*\+.*\+.*\+.*\+.*\+.*\+.*\+.*\+.*\+.*\+.*\+.*
      - CommandLine|matches: .*\{.*\{.*\{.*\{.*\{.*\{.*\{.*\{.*\{.*\{.*
      - CommandLine|matches: .*\^.*\^.*\^.*\^.*\^.*
      - CommandLine|matches: .*`.*`.*`.*`.*`.*
- filter_optional_amazonSSM:
  - and:
    - ParentImage|==: C:\Program Files\Amazon\SSM\ssm-document-worker.exe
- filter_optional_defender_atp:
  - and:
    - or:
      - CommandLine|contains: new EventSource("Microsoft.Windows.Sense.Client.Management"
      - CommandLine|contains: public static extern bool InstallELAMCertificateInfo(SafeFileHandle
          handle);
- condition: all of selection_* and not 1 of filter_optional_*
id: d7bcd677-645d-4691-a8d4-7a5602b780d1
logsource:
  category: process_creation
  product: windows
