detection:
- selection_img:
  - and:
    - or:
      - or:
        - Image|endswith: \powershell.exe
        - Image|endswith: \pwsh.exe
      - or:
        - OriginalFileName|==: PowerShell.EXE
        - OriginalFileName|==: pwsh.dll
- selection_cli:
  - and:
    - CommandLine|contains: Add-PSSnapin
- selection_module:
  - and:
    - or:
      - CommandLine|contains: Microsoft.Exchange.Powershell.Snapin
      - CommandLine|contains: Microsoft.Exchange.Management.PowerShell.SnapIn
- filter_msiexec:
  - and:
    - ParentImage|==: C:\Windows\System32\msiexec.exe
    - CommandLine|contains: $exserver=Get-ExchangeServer ([Environment]::MachineName)
        -ErrorVariable exerr 2> $null
- condition: all of selection_* and not 1 of filter_*
id: 25676e10-2121-446e-80a4-71ff8506af47
logsource:
  category: process_creation
  product: windows
